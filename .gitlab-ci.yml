image: docker:latest

before_script:
  - apt-get -qq update && apt-get -qq install -y python
  - apt-get -qq update
  - apt-get -qq install -y python python-virtualenv python-pip
  - virtualenv venv
  - . venv/bin/activate
  - python -V
  - pip install luigi

build:
  script:
    - docker build -t test .

minimal:
  script:
    - luigi --module fill_db FillDB --minimal

test:
  script:
    - container=$(docker ps -f name=gitlab-runner-luigi -q)
    - if [ -n "$container" ]; then docker stop $container && docker rm $container; fi
    - make startup
    - docker exec gitlab-runner-luigi make test  
    - make shutdown

lint:
  script:
    - python3 -m pip install flake8 --user
    - python3 -m flake8 -v --show-source .

coverage:
  script:
    - container=$(docker ps -f name=gitlab-runner-luigi -q)
    - if [ -n "$container" ]; then docker stop $container && docker rm $container; fi
    - make startup
    - docker exec gitlab-runner-luigi make coverage  
    - make shutdown
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
  artifacts:
    paths: 
      - htmlcov

